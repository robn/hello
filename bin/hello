#!/usr/bin/env perl

use 5.020;
use warnings;
use strict;
use experimental qw(postderef);

use IO::Async::Loop;
use TOML qw(from_toml);
use Module::Load qw(load);
use Hello::World;

my ($config, $err) = from_toml(do { local (@ARGV, $/) = ('config.toml'); <> });
warn $err unless $config;

#use Data::Dumper;
#print Dumper $config;

my $default_config = delete $config->{tester}->{_defaults_} // {};
my $default_interval = delete $default_config->{interval} // 120;
my $default_timeout  = delete $default_config->{timeout}  // 30;

my $loop = IO::Async::Loop->new;

my @collectors;

for my $collector_package (keys $config->{collector}->%*) {
  my $collector_config = delete $config->{collector}->{$collector_package} // {};

  load "Hello::Collector::$collector_package";

  my $collector = "Hello::Collector::$collector_package"->new(
    loop => $loop,
    %$collector_config,
  );

  $collector->init;

  push @collectors, $collector;
}

my @testers;

for my $tester_package (keys $config->{tester}->%*) {
  my $tester_list = delete $config->{tester}->{$tester_package} // [];

  load "Hello::Tester::$tester_package";

  for my $tester_config ($tester_list->@*) {
    my $tester_interval = delete $tester_config->{interval} // $default_interval;
    my $tester_timeout  = delete $tester_config->{timeout}  // $default_timeout;

    my $tester = "Hello::Tester::$tester_package"->new(
      loop     => $loop,
      interval => $tester_interval,
      timeout  => $tester_timeout,
      %$tester_config,
    );

    push @testers, $tester;
  }
}

Hello::World->new(
  loop => $loop,
  collectors => \@collectors,
  testers => \@testers,
)->go->get;

#my @f = map { [$_->get] } Future->wait_all(map { $_->test } @testers)->get;
#use Data::Dumper;
#print Dumper \@f;
